<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‘ Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f4f6f9; padding:20px; }
    .card { background:#fff; padding:20px; margin:15px auto; border-radius:8px;
            max-width:650px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
    h2 { margin-top:0; }
    label { display:block; margin:8px 0 5px; font-weight:bold; }
    input, button { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; font-weight:bold; }
    .primary { background:#2980B9; color:white; border:none; }
    .primary:hover { background:#1f6390; }
    .success { background:#27ae60; color:#fff; border:none; }
    .danger { background:#e74c3c; color:#fff; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card" id="loginBox">
    <h2>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
    <p id="loginError" style="color:red"></p>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
  <div id="employeeArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>ğŸ“¤ Ø±ÙØ¹ Ø¹Ø°Ø± Ø·Ø¨ÙŠ</h2>
      <button id="btnLogoutEmp" class="danger">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
    <label>ğŸ“Œ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
    <input type="text" id="empId" placeholder="Ù…Ø«Ø§Ù„: 12345">

    <label>ğŸ“… Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
    <input type="text" id="days" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø­Ø¯ØŒ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†">

    <label>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø°Ø± Ø§Ù„Ø·Ø¨ÙŠ</label>
    <input type="file" id="excuseFile">

    <button id="btnUpload" class="primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø°Ø±</button>
    <p id="uploadStatus"></p>

    <h3>ğŸ“‹ Ø£Ø¹Ø°Ø§Ø±ÙŠ</h3>
    <table>
      <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
      <tbody id="myExcuses"></tbody>
    </table>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø± -->
  <div id="leaderArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>ğŸ“‘ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¹Ø°Ø§Ø±</h2>
      <button id="btnLogoutLead" class="danger">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>

    <h3>ğŸ•“ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
    <table>
      <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody id="pendingExcuses"></tbody>
    </table>

    <h3>âœ… Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</h3>
    <table>
      <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
      <tbody id="approvedExcuses"></tbody>
    </table>
  </div>

  <script type="module">
    // âœ… Firebase config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCakP9nqvZuFZO3mXQ3jPBDT3JOcH0W3jY",
      authDomain: "sick-leave-80f29.firebaseapp.com",
      projectId: "sick-leave-80f29",
      storageBucket: "sick-leave-80f29.appspot.com",
      messagingSenderId: "381297448748",
      appId: "1:381297448748:web:9090c072007c0fc7fd3e89",
      databaseURL: "https://sick-leave-80f29-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const excusesRef = ref(db, "excuses");

    // âœ… Cloudinary config
    const CLOUD_NAME = "dq0y6h0z6";   
    const UPLOAD_PRESET = "sicklLcs"; 

    // Ø¹Ù†Ø§ØµØ± DOM
    const loginBox = document.getElementById("loginBox");
    const employeeArea = document.getElementById("employeeArea");
    const leaderArea = document.getElementById("leaderArea");
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
    const loginError = document.getElementById("loginError");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogoutEmp = document.getElementById("btnLogoutEmp");
    const btnLogoutLead = document.getElementById("btnLogoutLead");
    const empIdEl = document.getElementById("empId");
    const daysEl = document.getElementById("days");
    const fileEl = document.getElementById("excuseFile");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");
    const myExcusesTable = document.getElementById("myExcuses");
    const pendingExcusesTable = document.getElementById("pendingExcuses");
    const approvedExcusesTable = document.getElementById("approvedExcuses");

    let currentUser = null;
    let excuses = {};

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim().toLowerCase();
      const password = passwordEl.value.trim();
      if (!email || !password) {
        loginError.textContent = "âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.error(err);
        loginError.textContent = "âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
      }
    });

    // âœ… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loginBox.classList.add("hidden");
        if (user.email.endsWith("@emp.com")) {
          employeeArea.classList.remove("hidden");
        } else if (user.email.endsWith("@tl.com")) {
          leaderArea.classList.remove("hidden");
        }
      } else {
        currentUser = null;
        loginBox.classList.remove("hidden");
        employeeArea.classList.add("hidden");
        leaderArea.classList.add("hidden");
      }
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    btnLogoutEmp.addEventListener("click", () => signOut(auth));
    btnLogoutLead.addEventListener("click", () => signOut(auth));

    // âœ… Ø±ÙØ¹ Ø§Ù„Ø¹Ø°Ø±
    btnUpload.addEventListener("click", async () => {
      const empId = empIdEl.value.trim();
      const days = daysEl.value.trim();
      const file = fileEl.files[0];

      if (!empId || !days || !file) { 
        uploadStatus.textContent = "âš ï¸ Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"; 
        return; 
      }

      // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ø¹Ø°Ø± Ø¨Ø§Ù†ØªØ¸Ø§Ø±
      const hasPending = Object.values(excuses).some(e => e.email === currentUser.email && e.status === "Ø¨Ø§Ù†ØªØ¸Ø§Ø±");
      if (hasPending) {
        uploadStatus.textContent = "âš ï¸ Ù„Ø¯ÙŠÙƒ Ø¹Ø°Ø± Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¢Ø®Ø±.";
        return;
      }

      uploadStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        await push(excusesRef, {
          empId,
          days,
          url: data.secure_url,
          status: "Ø¨Ø§Ù†ØªØ¸Ø§Ø±",
          acceptedAt: null,
          email: currentUser.email,
          createdAt: Date.now()
        });

        uploadStatus.textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¹Ø°Ø±";
        empIdEl.value = ""; daysEl.value = ""; fileEl.value = "";
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹";
      }
    });

    // âœ… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¹Ø°Ø§Ø±
    onValue(excusesRef, (snap) => {
      excuses = snap.val() || {};
      refreshMyExcuses();
      refreshAllExcuses();
      cleanupExcuses();
    });

    // âœ… ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù
    function refreshMyExcuses(){
      if (!currentUser || !currentUser.email.endsWith("@emp.com")) return;
      myExcusesTable.innerHTML = "";
      Object.entries(excuses).forEach(([id, e]) => {
        if (e.email === currentUser.email) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                          <td><a href="${e.url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                          <td>${e.status}</td>`;
          myExcusesTable.appendChild(tr);
        }
      });
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ø°Ø§Ø± Ø§Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø±
    function refreshAllExcuses(){
      if (!currentUser || !currentUser.email.endsWith("@tl.com")) return;
      pendingExcusesTable.innerHTML = "";
      approvedExcusesTable.innerHTML = "";

      Object.entries(excuses).forEach(([id, e]) => {
        const tr = document.createElement("tr");
        if (e.status === "Ø¨Ø§Ù†ØªØ¸Ø§Ø±") {
          tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                          <td><a href="${e.url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                          <td>${e.status}</td>
                          <td><button class="success" onclick="acceptExcuse('${id}')">Ù‚Ø¨ÙˆÙ„ âœ…</button></td>`;
          pendingExcusesTable.appendChild(tr);
        } else if (e.status === "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„") {
          tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                          <td><a href="${e.url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                          <td>${e.status}</td>`;
          approvedExcusesTable.appendChild(tr);
        }
      });
    }

    // âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø°Ø±
    window.acceptExcuse = async (id) => {
      await update(ref(db, "excuses/" + id), {
        status: "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„",
        acceptedAt: Date.now()
      });
    };

    // âœ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù…
    async function cleanupExcuses(){
      const now = Date.now();
      Object.entries(excuses).forEach(async ([id, e]) => {
        if (e.status === "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„" && e.acceptedAt && (now - e.acceptedAt > 3*24*60*60*1000)) {
          await remove(ref(db, "excuses/" + id));
        }
      });
    }
  </script>
</body>
</html>
