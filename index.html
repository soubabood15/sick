<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <style>
    body { font-family: sans-serif; background:#f4f6f8; max-width:950px; margin:auto; padding:20px; }
    .card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); margin-bottom:20px; }
    input,button { width:100%; padding:10px; margin:8px 0; font-size:15px; }
    button { cursor:pointer; border:none; border-radius:5px; background:#2980B9; color:#fff; font-weight:bold; }
    button:hover { background:#1f6390; }
    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f9fafc; }
    .hidden { display:none; }
    .logout { background:#e74c3c; }
    .logout:hover { background:#c0392b; }
  </style>
</head>
<body>

  <h2>ğŸ“„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ©</h2>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox" class="card">
    <h3>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <input type="email" id="email" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù…Ø«Ø§Ù„: ali@emp.com Ø£Ùˆ leader@tl.com)" />
    <button id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
  <div id="employeeArea" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>ğŸ“¤ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h3>
      <button id="btnLogoutEmp" class="logout">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="card">
      <h3>ğŸ“¤ Ø±ÙØ¹ Ø¹Ø°Ø± Ø¬Ø¯ÙŠØ¯</h3>
      <input type="text" id="empNumber" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" inputmode="numeric" />
      <label>ğŸ“… Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØºÙŠØ§Ø¨</label>
      <input type="date" id="startDate" />
      <label>ğŸ“… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØºÙŠØ§Ø¨</label>
      <input type="date" id="endDate" />
      <input type="file" id="excuseFile" accept="image/*,.pdf" />
      <button id="btnSubmit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø°Ø±</button>
      <p id="uploadStatus"></p>
    </div>

    <div class="card">
      <h3>ğŸ“‹ Ø£Ø¹Ø°Ø§Ø±ÙŠ</h3>
      <table>
        <thead>
          <tr><th>Ø±Ù‚Ù… ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>
        </thead>
        <tbody id="employeeTable"></tbody>
      </table>
    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø± -->
  <div id="leaderArea" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>ğŸ“‹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø±</h3>
      <button id="btnLogoutLeader" class="logout">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="card">
      <h3>â³ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
      <table>
        <thead><tr><th>Ø±Ù‚Ù… ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody id="pendingTable"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>âœ… Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ù…Ù†ÙŠ</h3>
      <table>
        <thead><tr><th>Ø±Ù‚Ù… ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody id="approvedTable"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Cloudinary
    const CLOUD_NAME = "Ø¶Ø¹_Ù‡Ù†Ø§_cloud_name";
    const UPLOAD_PRESET = "Ø¶Ø¹_Ù‡Ù†Ø§_upload_preset";

    // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "Ø¶Ø¹_Ù‡Ù†Ø§_apiKey",
      authDomain: "sick-leave-80f29.firebaseapp.com",
      databaseURL: "https://sick-leave-80f29-default-rtdb.firebaseio.com",
      projectId: "sick-leave-80f29",
      storageBucket: "sick-leave-80f29.appspot.com",
      messagingSenderId: "381297448748",
      appId: "1:381297448748:web:9090c072007c0fc7fd3e89"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const excusesRef = ref(db, "excuses");

    // âœ… Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    const loginBox=document.getElementById("loginBox");
    const emailEl=document.getElementById("email");
    const btnLogin=document.getElementById("btnLogin");
    const loginError=document.getElementById("loginError");

    const employeeArea=document.getElementById("employeeArea");
    const leaderArea=document.getElementById("leaderArea");

    const btnLogoutEmp=document.getElementById("btnLogoutEmp");
    const btnLogoutLeader=document.getElementById("btnLogoutLeader");

    const empNumber=document.getElementById("empNumber");
    const startDate=document.getElementById("startDate");
    const endDate=document.getElementById("endDate");
    const excuseFile=document.getElementById("excuseFile");
    const btnSubmit=document.getElementById("btnSubmit");
    const uploadStatus=document.getElementById("uploadStatus");
    const employeeTable=document.getElementById("employeeTable");

    const pendingTable=document.getElementById("pendingTable");
    const approvedTable=document.getElementById("approvedTable");

    let currentUserEmail="";
    let currentRole="";

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    btnLogin.addEventListener("click", ()=>{
      const email=emailEl.value.trim().toLowerCase();
      if(!email){ loginError.textContent="âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"; return; }

      if(email.endsWith("@emp.com")){
        currentUserEmail=email;
        currentRole="employee";
        loginBox.classList.add("hidden");
        employeeArea.classList.remove("hidden");
      } else if(email.endsWith("@tl.com")){
        currentUserEmail=email;
        currentRole="leader";
        loginBox.classList.add("hidden");
        leaderArea.classList.remove("hidden");
      } else {
        loginError.textContent="âš ï¸ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ @emp.com Ø£Ùˆ @tl.com";
      }
    });

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout(){
      currentUserEmail="";
      currentRole="";
      employeeArea.classList.add("hidden");
      leaderArea.classList.add("hidden");
      loginBox.classList.remove("hidden");
      emailEl.value="";
    }
    btnLogoutEmp.addEventListener("click", logout);
    btnLogoutLeader.addEventListener("click", logout);

    // âœ… Ø±ÙØ¹ Ø§Ù„Ø¹Ø°Ø± (Ù„Ù„Ù…ÙˆØ¸Ù)
    btnSubmit?.addEventListener("click", async ()=>{
      if(!empNumber.value || !startDate.value || !endDate.value || !excuseFile.files[0]){
        alert("âš ï¸ Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");return;
      }
      const file=excuseFile.files[0];
      const formData=new FormData();
      formData.append("file",file);
      formData.append("upload_preset",UPLOAD_PRESET);

      uploadStatus.textContent="â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...";
      try{
        const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,{method:"POST",body:formData});
        const data=await res.json();
        if(data.secure_url){
          await push(excusesRef,{
            empNumber:empNumber.value,
            startDate:startDate.value,
            endDate:endDate.value,
            fileUrl:data.secure_url,
            status:"pending",
            createdBy: currentUserEmail
          });
          uploadStatus.textContent="âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¹Ø°Ø±";
          empNumber.value=""; startDate.value=""; endDate.value=""; excuseFile.value="";
        }else{
          uploadStatus.textContent="âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù";
        }
      }catch(err){
        console.error(err);
        uploadStatus.textContent="âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹";
      }
    });

    // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    onValue(excusesRef,(snap)=>{
      const data=snap.val()||{};
      employeeTable.innerHTML="";
      pendingTable.innerHTML="";
      approvedTable.innerHTML="";

      Object.entries(data).forEach(([id,e])=>{
        if(currentRole==="employee" && e.createdBy===currentUserEmail){
          employeeTable.innerHTML+=`
            <tr>
              <td>${e.empNumber}</td>
              <td>${e.startDate} â†’ ${e.endDate}</td>
              <td><a href="${e.fileUrl}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
              <td>${e.status}</td>
            </tr>`;
        }

        if(currentRole==="leader"){
          if(e.status==="pending"){
            pendingTable.innerHTML+=`
              <tr>
                <td>${e.empNumber}</td>
                <td>${e.startDate} â†’ ${e.endDate}</td>
                <td><a href="${e.fileUrl}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                <td><button onclick="approveExcuse('${id}')">âœ… Ù‚Ø¨ÙˆÙ„</button></td>
              </tr>`;
          } else if(e.status==="approved" && e.approvedBy===currentUserEmail){
            approvedTable.innerHTML+=`
              <tr>
                <td>${e.empNumber}</td>
                <td>${e.startDate} â†’ ${e.endDate}</td>
                <td><a href="${e.fileUrl}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                <td>âœ… Ù…Ù‚Ø¨ÙˆÙ„</td>
              </tr>`;
          }
        }
      });
    });

    // âœ… Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø±
    window.approveExcuse=async(id)=>{
      const excuseRef=ref(db,"excuses/"+id);
      await update(excuseRef,{status:"approved",approvedBy:currentUserEmail});
      alert("âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø°Ø±");
    }
  </script>
</body>
</html>
