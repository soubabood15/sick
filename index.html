<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>📑 نظام رفع الأعذار الطبية</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f4f6f9; padding:20px; }
    .card { background:#fff; padding:20px; margin:15px auto; border-radius:8px;
            max-width:650px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
    h2 { margin-top:0; }
    label { display:block; margin:8px 0 5px; font-weight:bold; }
    input, button { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; font-weight:bold; }
    .primary { background:#2980B9; color:white; border:none; }
    .primary:hover { background:#1f6390; }
    .success { background:#27ae60; color:#fff; border:none; }
    .danger { background:#e74c3c; color:#fff; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card" id="loginBox">
    <h2>🔑 تسجيل دخول</h2>
    <input type="email" id="email" placeholder="الإيميل">
    <input type="password" id="password" placeholder="كلمة المرور">
    <button id="btnLogin" class="primary">دخول</button>
    <p id="loginError" style="color:red"></p>
  </div>

  <!-- واجهة الموظف -->
  <div id="employeeArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>📤 رفع عذر طبي</h2>
      <button id="btnLogoutEmp" class="danger">🚪 خروج</button>
    </div>
    <label>📌 الرقم الوظيفي</label>
    <input type="text" id="empId" placeholder="مثال: 12345">

    <label>📅 الأيام المطلوبة</label>
    <input type="text" id="days" placeholder="مثال: الأحد، الإثنين">

    <label>📷 صورة العذر الطبي</label>
    <input type="file" id="excuseFile">

    <button id="btnUpload" class="primary">إرسال العذر</button>
    <p id="uploadStatus"></p>

    <h3>📋 أعذاري</h3>
    <table>
      <thead><tr><th>الرقم</th><th>الأيام</th><th>الرابط</th><th>الحالة</th></tr></thead>
      <tbody id="myExcuses"></tbody>
    </table>
  </div>

  <!-- واجهة التيم ليدر -->
  <div id="leaderArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>📑 مراجعة الأعذار</h2>
      <button id="btnLogoutLead" class="danger">🚪 خروج</button>
    </div>

    <h3>🕓 الأعذار المعلقة</h3>
    <table>
      <thead><tr><th>الموظف</th><th>الأيام</th><th>الرابط</th><th>الحالة</th><th>إجراء</th></tr></thead>
      <tbody id="pendingExcuses"></tbody>
    </table>

    <h3>✅ الأعذار المقبولة</h3>
    <table>
      <thead><tr><th>الموظف</th><th>الأيام</th><th>الرابط</th><th>الحالة</th></tr></thead>
      <tbody id="approvedExcuses"></tbody>
    </table>
  </div>

  <script type="module">
    // ✅ Firebase config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCakP9nqvZuFZO3mXQ3jPBDT3JOcH0W3jY",
      authDomain: "sick-leave-80f29.firebaseapp.com",
      projectId: "sick-leave-80f29",
      storageBucket: "sick-leave-80f29.appspot.com",
      messagingSenderId: "381297448748",
      appId: "1:381297448748:web:9090c072007c0fc7fd3e89",
      databaseURL: "https://sick-leave-80f29-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const excusesRef = ref(db, "excuses");

    // ✅ Cloudinary config
    const CLOUD_NAME = "dq0y6h0z6";   
    const UPLOAD_PRESET = "sicklLcs"; 

    // عناصر DOM
    const loginBox = document.getElementById("loginBox");
    const employeeArea = document.getElementById("employeeArea");
    const leaderArea = document.getElementById("leaderArea");
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
    const loginError = document.getElementById("loginError");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogoutEmp = document.getElementById("btnLogoutEmp");
    const btnLogoutLead = document.getElementById("btnLogoutLead");
    const empIdEl = document.getElementById("empId");
    const daysEl = document.getElementById("days");
    const fileEl = document.getElementById("excuseFile");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");
    const myExcusesTable = document.getElementById("myExcuses");
    const pendingExcusesTable = document.getElementById("pendingExcuses");
    const approvedExcusesTable = document.getElementById("approvedExcuses");

    let currentUser = null;
    let excuses = {};

    // ✅ تسجيل الدخول
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim().toLowerCase();
      const password = passwordEl.value.trim();
      if (!email || !password) {
        loginError.textContent = "❌ أدخل الإيميل وكلمة المرور";
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.error(err);
        loginError.textContent = "❌ بيانات الدخول غير صحيحة";
      }
    });

    // ✅ متابعة الدخول
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loginBox.classList.add("hidden");
        if (user.email.endsWith("@emp.com")) {
          employeeArea.classList.remove("hidden");
        } else if (user.email.endsWith("@tl.com")) {
          leaderArea.classList.remove("hidden");
        }
      } else {
        currentUser = null;
        loginBox.classList.remove("hidden");
        employeeArea.classList.add("hidden");
        leaderArea.classList.add("hidden");
      }
    });

    // تسجيل خروج
    btnLogoutEmp.addEventListener("click", () => signOut(auth));
    btnLogoutLead.addEventListener("click", () => signOut(auth));

    // ✅ رفع العذر
    btnUpload.addEventListener("click", async () => {
      const empId = empIdEl.value.trim();
      const days = daysEl.value.trim();
      const file = fileEl.files[0];

      if (!empId || !days || !file) { 
        uploadStatus.textContent = "⚠️ أدخل كل الحقول"; 
        return; 
      }

      // تحقق إذا عنده عذر بانتظار
      const hasPending = Object.values(excuses).some(e => e.email === currentUser.email && e.status === "بانتظار");
      if (hasPending) {
        uploadStatus.textContent = "⚠️ لديك عذر بانتظار القبول. لا يمكنك رفع آخر.";
        return;
      }

      uploadStatus.textContent = "⏳ جاري الرفع...";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        await push(excusesRef, {
          empId,
          days,
          url: data.secure_url,
          status: "بانتظار",
          acceptedAt: null,
          email: currentUser.email,
          createdAt: Date.now()
        });

        uploadStatus.textContent = "✅ تم رفع العذر";
        empIdEl.value = ""; daysEl.value = ""; fileEl.value = "";
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "❌ خطأ في الرفع";
      }
    });

    // ✅ متابعة الأعذار
    onValue(excusesRef, (snap) => {
      excuses = snap.val() || {};
      refreshMyExcuses();
      refreshAllExcuses();
      cleanupExcuses();
    });

    // ✅ تحديث أعذار الموظف
    function refreshMyExcuses(){
      if (!currentUser || !currentUser.email.endsWith("@emp.com")) return;
      myExcusesTable.innerHTML = "";
      Object.entries(excuses).forEach(([id, e]) => {
        if (e.email === currentUser.email) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                          <td><a href="${e.url}" target="_blank">📎 عرض</a></td>
                          <td>${e.status}</td>`;
          myExcusesTable.appendChild(tr);
        }
      });
    }

    // ✅ تحديث أعذار التيم ليدر
    function refreshAllExcuses(){
      if (!currentUser || !currentUser.email.endsWith("@tl.com")) return;
      pendingExcusesTable.innerHTML = "";
      approvedExcusesTable.innerHTML = "";

      Object.entries(excuses).forEach(([id, e]) => {
        const tr = document.createElement("tr");
        if (e.status === "بانتظار") {
          tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                          <td><a href="${e.url}" target="_blank">📎 عرض</a></td>
                          <td>${e.status}</td>
                          <td><button class="success" onclick="acceptExcuse('${id}')">قبول ✅</button></td>`;
          pendingExcusesTable.appendChild(tr);
        } else if (e.status === "تم القبول") {
          tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                          <td><a href="${e.url}" target="_blank">📎 عرض</a></td>
                          <td>${e.status}</td>`;
          approvedExcusesTable.appendChild(tr);
        }
      });
    }

    // ✅ قبول العذر
    window.acceptExcuse = async (id) => {
      await update(ref(db, "excuses/" + id), {
        status: "تم القبول",
        acceptedAt: Date.now()
      });
    };

    // ✅ تنظيف الأعذار المقبولة بعد 3 أيام
    async function cleanupExcuses(){
      const now = Date.now();
      Object.entries(excuses).forEach(async ([id, e]) => {
        if (e.status === "تم القبول" && e.acceptedAt && (now - e.acceptedAt > 3*24*60*60*1000)) {
          await remove(ref(db, "excuses/" + id));
        }
      });
    }
  </script>
</body>
</html>
