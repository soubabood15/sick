<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‘ Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f4f6f9; padding:20px; }
    .card { background:#fff; padding:20px; margin:15px auto; border-radius:8px;
            max-width:650px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
    h2 { margin-top:0; }
    label { display:block; margin:8px 0 5px; font-weight:bold; }
    input, button { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; font-weight:bold; }
    .primary { background:#2980B9; color:white; border:none; }
    .primary:hover { background:#1f6390; }
    .success { background:#27ae60; color:#fff; border:none; }
    .danger { background:#e74c3c; color:#fff; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card" id="loginBox">
    <h2>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù…Ø«Ø§Ù„ emp@emp.com Ø£Ùˆ lead@tl.com)">
    <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
    <p id="loginError" style="color:red"></p>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
  <div id="employeeArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>ğŸ“¤ Ø±ÙØ¹ Ø¹Ø°Ø± Ø·Ø¨ÙŠ</h2>
      <button id="btnLogoutEmp" class="danger">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
    <label>ğŸ“Œ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
    <input type="text" id="empId" placeholder="Ù…Ø«Ø§Ù„: 12345">

    <label>ğŸ“… Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
    <input type="text" id="days" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø­Ø¯ØŒ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†">

    <label>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø°Ø± Ø§Ù„Ø·Ø¨ÙŠ</label>
    <input type="file" id="excuseFile">

    <button id="btnUpload" class="primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø°Ø±</button>
    <p id="uploadStatus"></p>

    <h3>ğŸ“‹ Ø£Ø¹Ø°Ø§Ø±ÙŠ</h3>
    <table>
      <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
      <tbody id="myExcuses"></tbody>
    </table>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø± -->
  <div id="leaderArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>ğŸ“‘ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¹Ø°Ø§Ø±</h2>
      <button id="btnLogoutLead" class="danger">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
    <table>
      <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody id="allExcuses"></tbody>
    </table>
  </div>

  <script type="module">
    // ğŸ“Œ Cloudinary config
    const CLOUD_NAME = "dq0y6h0z6";   
    const UPLOAD_PRESET = "sicklLcs"; 

    // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ© (Ù…ØµÙÙˆÙØ©)
    let excuses = [];

    // Ø¹Ù†Ø§ØµØ± DOM
    const loginBox = document.getElementById("loginBox");
    const employeeArea = document.getElementById("employeeArea");
    const leaderArea = document.getElementById("leaderArea");
    const emailEl = document.getElementById("email");
    const loginError = document.getElementById("loginError");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogoutEmp = document.getElementById("btnLogoutEmp");
    const btnLogoutLead = document.getElementById("btnLogoutLead");
    const empIdEl = document.getElementById("empId");
    const daysEl = document.getElementById("days");
    const fileEl = document.getElementById("excuseFile");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");
    const myExcusesTable = document.getElementById("myExcuses");
    const allExcusesTable = document.getElementById("allExcuses");

    let currentUser = null;

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    btnLogin.addEventListener("click", () => {
      const email = emailEl.value.trim().toLowerCase();
      if (!email) { loginError.textContent = "âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"; return; }

      if (email.endsWith("@emp.com")) {
        currentUser = { role:"employee", email };
        loginBox.classList.add("hidden");
        employeeArea.classList.remove("hidden");
        refreshMyExcuses();
      } 
      else if (email.endsWith("@tl.com")) {
        currentUser = { role:"leader", email };
        loginBox.classList.add("hidden");
        leaderArea.classList.remove("hidden");
        refreshAllExcuses();
      } 
      else {
        loginError.textContent = "âŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­";
      }
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    btnLogoutEmp.addEventListener("click", () => {
      currentUser = null;
      employeeArea.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });
    btnLogoutLead.addEventListener("click", () => {
      currentUser = null;
      leaderArea.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });

    // Ø±ÙØ¹ Ø§Ù„Ø¹Ø°Ø±
    btnUpload.addEventListener("click", async () => {
      const empId = empIdEl.value.trim();
      const days = daysEl.value.trim();
      const file = fileEl.files[0];
      if (!empId || !days || !file) { 
        uploadStatus.textContent = "âš ï¸ Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"; 
        return; 
      }

      uploadStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        const excuse = {
          id: Date.now(),
          empId,
          days,
          url: data.secure_url,
          status: "Ø¨Ø§Ù†ØªØ¸Ø§Ø±",
          acceptedAt: null,
          email: currentUser.email
        };
        excuses.push(excuse);
        uploadStatus.textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¹Ø°Ø±";
        empIdEl.value = ""; daysEl.value = ""; fileEl.value = "";
        refreshMyExcuses();
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹";
      }
    });

    // ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù
    function refreshMyExcuses(){
      if (!currentUser || currentUser.role !== "employee") return;
      myExcusesTable.innerHTML = "";
      excuses.filter(e => e.email === currentUser.email).forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                        <td><a href="${e.url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                        <td>${e.status}</td>`;
        myExcusesTable.appendChild(tr);
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ù„Ù„ØªÙŠÙ… Ù„ÙŠØ¯Ø±
    function refreshAllExcuses(){
      if (!currentUser || currentUser.role !== "leader") return;
      allExcusesTable.innerHTML = "";
      excuses.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                        <td><a href="${e.url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶</a></td>
                        <td>${e.status}</td>
                        <td>${e.status==="Ø¨Ø§Ù†ØªØ¸Ø§Ø±" 
                          ? `<button class="success" onclick="acceptExcuse(${e.id})">Ù‚Ø¨ÙˆÙ„ âœ…</button>` 
                          : "â€”"}</td>`;
        allExcusesTable.appendChild(tr);
      });
    }

    // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø°Ø±
    window.acceptExcuse = (id) => {
      excuses = excuses.map(e => 
        e.id===id ? {...e, status:"ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„", acceptedAt: Date.now()} : e
      );
      refreshAllExcuses();
      refreshMyExcuses();
    };

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù…
    function cleanupExcuses(){
      const now = Date.now();
      excuses = excuses.filter(e => 
        !(e.status==="ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„" && e.acceptedAt && (now - e.acceptedAt > 3*24*60*60*1000))
      );
      refreshMyExcuses();
      refreshAllExcuses();
    }
    setInterval(cleanupExcuses, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
  </script>
</body>
</html>
