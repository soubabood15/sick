<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>📑 نظام رفع الأعذار الطبية</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f4f6f9; padding:20px; }
    .card { background:#fff; padding:20px; margin:15px auto; border-radius:8px;
            max-width:650px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
    h2 { margin-top:0; }
    label { display:block; margin:8px 0 5px; font-weight:bold; }
    input, button { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; font-weight:bold; }
    .primary { background:#2980B9; color:white; border:none; }
    .primary:hover { background:#1f6390; }
    .success { background:#27ae60; color:#fff; border:none; }
    .danger { background:#e74c3c; color:#fff; border:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card" id="loginBox">
    <h2>🔑 تسجيل دخول</h2>
    <input type="email" id="email" placeholder="الإيميل (مثال emp@emp.com أو lead@tl.com)">
    <button id="btnLogin" class="primary">دخول</button>
    <p id="loginError" style="color:red"></p>
  </div>

  <!-- واجهة الموظف -->
  <div id="employeeArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>📤 رفع عذر طبي</h2>
      <button id="btnLogoutEmp" class="danger">🚪 خروج</button>
    </div>
    <label>📌 الرقم الوظيفي</label>
    <input type="text" id="empId" placeholder="مثال: 12345">

    <label>📅 الأيام المطلوبة</label>
    <input type="text" id="days" placeholder="مثال: الأحد، الإثنين">

    <label>📷 صورة العذر الطبي</label>
    <input type="file" id="excuseFile">

    <button id="btnUpload" class="primary">إرسال العذر</button>
    <p id="uploadStatus"></p>

    <h3>📋 أعذاري</h3>
    <table>
      <thead><tr><th>الرقم</th><th>الأيام</th><th>الرابط</th><th>الحالة</th></tr></thead>
      <tbody id="myExcuses"></tbody>
    </table>
  </div>

  <!-- واجهة التيم ليدر -->
  <div id="leaderArea" class="hidden card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>📑 مراجعة الأعذار</h2>
      <button id="btnLogoutLead" class="danger">🚪 خروج</button>
    </div>
    <table>
      <thead><tr><th>الموظف</th><th>الأيام</th><th>الرابط</th><th>الحالة</th><th>إجراء</th></tr></thead>
      <tbody id="allExcuses"></tbody>
    </table>
  </div>

  <script type="module">
    // 📌 Cloudinary config
    const CLOUD_NAME = "dq0y6h0z6";   
    const UPLOAD_PRESET = "sicklLcs"; 

    // قاعدة بيانات مؤقتة (مصفوفة)
    let excuses = [];

    // عناصر DOM
    const loginBox = document.getElementById("loginBox");
    const employeeArea = document.getElementById("employeeArea");
    const leaderArea = document.getElementById("leaderArea");
    const emailEl = document.getElementById("email");
    const loginError = document.getElementById("loginError");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogoutEmp = document.getElementById("btnLogoutEmp");
    const btnLogoutLead = document.getElementById("btnLogoutLead");
    const empIdEl = document.getElementById("empId");
    const daysEl = document.getElementById("days");
    const fileEl = document.getElementById("excuseFile");
    const btnUpload = document.getElementById("btnUpload");
    const uploadStatus = document.getElementById("uploadStatus");
    const myExcusesTable = document.getElementById("myExcuses");
    const allExcusesTable = document.getElementById("allExcuses");

    let currentUser = null;

    // تسجيل الدخول
    btnLogin.addEventListener("click", () => {
      const email = emailEl.value.trim().toLowerCase();
      if (!email) { loginError.textContent = "❌ أدخل الإيميل"; return; }

      if (email.endsWith("@emp.com")) {
        currentUser = { role:"employee", email };
        loginBox.classList.add("hidden");
        employeeArea.classList.remove("hidden");
        refreshMyExcuses();
      } 
      else if (email.endsWith("@tl.com")) {
        currentUser = { role:"leader", email };
        loginBox.classList.add("hidden");
        leaderArea.classList.remove("hidden");
        refreshAllExcuses();
      } 
      else {
        loginError.textContent = "❌ الإيميل غير صحيح";
      }
    });

    // تسجيل خروج
    btnLogoutEmp.addEventListener("click", () => {
      currentUser = null;
      employeeArea.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });
    btnLogoutLead.addEventListener("click", () => {
      currentUser = null;
      leaderArea.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });

    // رفع العذر
    btnUpload.addEventListener("click", async () => {
      const empId = empIdEl.value.trim();
      const days = daysEl.value.trim();
      const file = fileEl.files[0];
      if (!empId || !days || !file) { 
        uploadStatus.textContent = "⚠️ أدخل كل الحقول"; 
        return; 
      }

      uploadStatus.textContent = "⏳ جاري الرفع...";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        const excuse = {
          id: Date.now(),
          empId,
          days,
          url: data.secure_url,
          status: "بانتظار",
          acceptedAt: null,
          email: currentUser.email
        };
        excuses.push(excuse);
        uploadStatus.textContent = "✅ تم رفع العذر";
        empIdEl.value = ""; daysEl.value = ""; fileEl.value = "";
        refreshMyExcuses();
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "❌ خطأ في الرفع";
      }
    });

    // تحديث أعذار الموظف
    function refreshMyExcuses(){
      if (!currentUser || currentUser.role !== "employee") return;
      myExcusesTable.innerHTML = "";
      excuses.filter(e => e.email === currentUser.email).forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                        <td><a href="${e.url}" target="_blank">📎 عرض</a></td>
                        <td>${e.status}</td>`;
        myExcusesTable.appendChild(tr);
      });
    }

    // تحديث الأعذار للتيم ليدر
    function refreshAllExcuses(){
      if (!currentUser || currentUser.role !== "leader") return;
      allExcusesTable.innerHTML = "";
      excuses.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${e.empId}</td><td>${e.days}</td>
                        <td><a href="${e.url}" target="_blank">📎 عرض</a></td>
                        <td>${e.status}</td>
                        <td>${e.status==="بانتظار" 
                          ? `<button class="success" onclick="acceptExcuse(${e.id})">قبول ✅</button>` 
                          : "—"}</td>`;
        allExcusesTable.appendChild(tr);
      });
    }

    // قبول العذر
    window.acceptExcuse = (id) => {
      excuses = excuses.map(e => 
        e.id===id ? {...e, status:"تم القبول", acceptedAt: Date.now()} : e
      );
      refreshAllExcuses();
      refreshMyExcuses();
    };

    // تنظيف الأعذار المقبولة بعد 3 أيام
    function cleanupExcuses(){
      const now = Date.now();
      excuses = excuses.filter(e => 
        !(e.status==="تم القبول" && e.acceptedAt && (now - e.acceptedAt > 3*24*60*60*1000))
      );
      refreshMyExcuses();
      refreshAllExcuses();
    }
    setInterval(cleanupExcuses, 60000); // كل دقيقة
  </script>
</body>
</html>
